<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Toolbox API - Dashboard</title>
  <script src="https://unpkg.com/htmx.org@1.9.6"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/preact@10.15.1/dist/preact.umd.js"></script>
  <script src="https://unpkg.com/preact@10.15.1/hooks/dist/hooks.umd.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f0f0f0;
    }
    .neo-card {
      background: #FFFFFF;
      border: 3px solid #000000;
      border-radius: 12px;
      box-shadow: 8px 8px 0 #000000;
      transition: all 0.2s ease;
    }
    .neo-card:hover {
      transform: translate(-2px, -2px);
      box-shadow: 10px 10px 0 #000000;
    }
    .neo-btn {
      background: #4F46E5;
      color: white;
      border: 2px solid #000000;
      border-radius: 8px;
      box-shadow: 4px 4px 0 #000000;
      transition: all 0.2s ease;
      font-weight: 600;
      padding: 0.5rem 1rem;
    }
    .neo-btn:hover:not(:disabled) {
      transform: translate(-1px, -1px);
      box-shadow: 5px 5px 0 #000000;
    }
    .neo-btn:active:not(:disabled) {
      transform: translate(1px, 1px);
      box-shadow: 3px 3px 0 #000000;
    }
    .neo-input {
      border: 2px solid #000000;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      box-shadow: 3px 3px 0 #000000;
      transition: all 0.2s ease;
    }
    .neo-input:focus {
      outline: none;
      border-color: #4F46E5;
      box-shadow: 3px 3px 0 #4F46E5;
    }
    .api-key-display {
      letter-spacing: 1px;
      font-family: 'Courier New', monospace;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <div id="app" class="w-full max-w-2xl">
    <div class="neo-card p-8 mb-8">
      <h1 class="text-3xl font-bold mb-6 text-center">Dashboard de API</h1>
      <!-- App will be rendered here by Preact -->
    </div>
  </div>

  <script>
    // Función para inicializar la aplicación
    function initApp() {
      // Verificar que Preact esté disponible
      if (typeof window.preact === 'undefined' || typeof window.preactHooks === 'undefined') {
        console.error('Preact no está disponible');
        return;
      }

      const { h, render } = window.preact;
      const { useState, useEffect } = window.preactHooks;

      // API Service
      const apiService = {
        async checkAuth() {
          try {
            const response = await fetch('/api/auth/me', {
              credentials: 'include'
            });
            if (!response.ok) throw new Error('Not authenticated');
            return await response.json();
          } catch (error) {
            throw error;
          }
        },

        async getApiKeys() {
          const response = await fetch('/api/keys/list', {
            credentials: 'include'
          });
          if (!response.ok) throw new Error('Failed to fetch API keys');
          return await response.json();
        },

        async createApiKey() {
          const response = await fetch('/api/keys/create', {
            method: 'POST',
            credentials: 'include',
            headers: {
              'Content-Type': 'application/json',
            },
          });
          if (!response.ok) throw new Error('Failed to create API key');
          return await response.json();
        },

        async revokeApiKey(id) {
          const response = await fetch(`/api/keys/revoke/${id}`, {
            method: 'POST',
            credentials: 'include',
          });
          if (!response.ok) throw new Error('Failed to revoke API key');
          return await response.json();
        }
      };

      // API Key Component
      function ApiKeySection({ isAuthenticated }) {
        const [apiKey, setApiKey] = useState('');
        const [showKey, setShowKey] = useState(false);
        const [error, setError] = useState(null);

        useEffect(() => {
          if (isAuthenticated) {
            loadApiKey();
          }
        }, [isAuthenticated]);

        const loadApiKey = async () => {
          try {
            const data = await apiService.getApiKeys();
            if (data && data.length > 0) {
              setApiKey(data[0].key);
            }
          } catch (err) {
            setError('Error loading API key');
            console.error(err);
          }
        };

        const handleCreateKey = async () => {
          try {
            const data = await apiService.createApiKey();
            setApiKey(data.key);
            setError(null);
          } catch (err) {
            setError('Error creating API key');
            console.error(err);
          }
        };

        const handleRegenerateKey = async () => {
          if (confirm('¿Estás seguro de que deseas regenerar tu API Key? La clave actual dejará de funcionar.')) {
            try {
              // Get current keys to find the ID
              const currentKeys = await apiService.getApiKeys();
              if (currentKeys && currentKeys.length > 0) {
                await apiService.revokeApiKey(currentKeys[0].id);
              }
              const data = await apiService.createApiKey();
              setApiKey(data.key);
              setError(null);
            } catch (err) {
              setError('Error regenerating API key');
              console.error(err);
            }
          }
        };

        const copyToClipboard = () => {
          navigator.clipboard.writeText(apiKey);
          alert('API Key copiada al portapapeles');
        };

        if (!isAuthenticated) {
          return (
            h('div', { className: 'text-center py-8' },
              h('p', { className: 'mb-4' }, 'Debes iniciar sesión para acceder a tu API Key'),
              h('button', {
                className: 'neo-btn',
                onClick: () => window.location.href = '/login'
              }, 'Iniciar sesión')
            )
          );
        }

        if (error) {
          return (
            h('div', { className: 'text-center py-8 text-red-600' },
              h('p', { className: 'mb-4' }, error),
              h('button', {
                className: 'neo-btn',
                onClick: loadApiKey
              }, 'Reintentar')
            )
          );
        }

        if (!apiKey) {
          return (
            h('div', { className: 'text-center py-8' },
              h('p', { className: 'mb-4' }, 'No tienes una API Key generada.'),
              h('button', {
                className: 'neo-btn',
                onClick: handleCreateKey
              }, 'Generar API Key')
            )
          );
        }

        return (
          h('div', { className: 'space-y-4 mb-8' },
            h('h2', { className: 'text-xl font-semibold mb-4' }, 'Tu API Key'),
            h('div', { className: 'flex items-center gap-2 mb-4' },
              h('div', { className: 'relative flex-1' },
                h('input', {
                  id: 'apiKey',
                  type: showKey ? 'text' : 'password',
                  value: apiKey,
                  readOnly: true,
                  className: 'w-full neo-input api-key-display',
                  style: { paddingRight: '2.5rem' }
                }),
                h('button', {
                  className: 'absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-600 hover:text-gray-800',
                  onClick: () => setShowKey(!showKey),
                  type: 'button',
                  'aria-label': showKey ? 'Ocultar clave' : 'Mostrar clave'
                }, h('i', { className: showKey ? 'fas fa-eye-slash' : 'fas fa-eye' }))
              ),
              h('button', {
                className: 'neo-btn bg-blue-600',
                onClick: copyToClipboard,
                type: 'button'
              }, h('i', { className: 'fas fa-copy mr-2' }), 'Copiar')
            ),
            h('div', { className: 'flex justify-end' },
              h('button', {
                className: 'neo-btn bg-red-500 hover:bg-red-600',
                onClick: handleRegenerateKey,
                type: 'button'
              }, h('i', { className: 'fas fa-sync-alt mr-2' }), 'Regenerar')
            )
          )
        );
      }

      // Documentation Component
      function DocumentationSection() {
        return (
          h('div', { className: 'border-t border-gray-200 pt-6' },
            h('h2', { className: 'text-xl font-semibold mb-4' }, 'Documentación'),
            h('div', { className: 'space-y-4' },
              h('div', { className: 'p-4 bg-gray-50 rounded-lg' },
                h('h3', { className: 'font-medium mb-2' }, 'Endpoint Base'),
                h('code', { className: 'bg-gray-100 p-2 rounded text-sm block overflow-x-auto' },
                  'https://toolbox-api.fly.dev/api/tool'
                )
              ),
              h('div', { className: 'p-4 bg-gray-50 rounded-lg' },
                h('h3', { className: 'font-medium mb-2' }, 'Autenticación'),
                h('p', { className: 'text-sm mb-2' }, 'Incluye tu API Key en el encabezado de la solicitud:'),
                h('code', { className: 'bg-gray-100 p-2 rounded text-sm block overflow-x-auto' },
                  'Authorization: Bearer <tu_api_key>'
                )
              )
            )
          )
        );
      }

      // Main App Component
      function App() {
        const [isAuthenticated, setIsAuthenticated] = useState(false);
        const [authChecked, setAuthChecked] = useState(false);

        useEffect(() => {
          const checkAuth = async () => {
            try {
              await apiService.checkAuth();
              setIsAuthenticated(true);
            } catch (error) {
              setIsAuthenticated(false);
            } finally {
              setAuthChecked(true);
            }
          };

          checkAuth();
        }, []);

        // Don't render anything until auth is checked
        if (!authChecked) {
          return null;
        }

        return (
          h('div', { className: 'space-y-8' },
            h(ApiKeySection, { isAuthenticated }),
            h(DocumentationSection)
          )
        );
      }

      // Render the app
      const appContainer = document.querySelector('#app .neo-card');
      if (appContainer) {
        // Clear existing content except the title
        const title = appContainer.querySelector('h1');
        appContainer.innerHTML = '';
        if (title) {
          appContainer.appendChild(title);
        }
        
        // Create a container for the app
        const appDiv = document.createElement('div');
        appContainer.appendChild(appDiv);
        
        // Render the app
        render(h(App), appDiv);
        console.log('App renderizada correctamente');
      } else {
        console.error('No se encontró el contenedor #app .neo-card');
      }
    }

    // Inicializar cuando todo esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }
  </script>
</body>
</html>
